# Mattermost 收到消息聚合插件

这个插件可以自动聚合频道中的"收到"确认消息，将多个用户的确认合并到一条消息中，避免频道被大量相同的确认消息刷屏。

## 功能特性

- 🎯 **自动聚合**：当多个用户发送相同的确认消息时，自动合并到一条消息中
- 🔧 **可配置触发词**：支持自定义触发词，默认支持"收到"、"已收到"、"确认"
- 📊 **用户列表显示**：清晰显示所有已确认的用户名
- 🚫 **避免重复**：同一用户多次确认不会重复显示
- ⚡ **实时更新**：消息实时更新，无需刷新页面

## 工作原理

1. 用户A发送"收到" → 消息显示为："收到 -- 用户A"
2. 用户B发送"收到" → 消息更新为："收到 -- 用户A, 用户B"  
3. 用户C发送"收到" → 消息更新为："收到 -- 用户A, 用户B, 用户C"
4. 用户B再次发送"收到" → 消息不变（避免重复）

## 安装步骤

### 1. 构建插件

确保你已安装Go 1.16+：

```bash
# 克隆代码
git clone <repository-url>
cd mattermost-plugin-received-aggregator

# 初始化构建工具
make apply

# 构建插件
make dist
```

### 2. 安装到Mattermost

1. 登录Mattermost管理员界面
2. 进入 **System Console** → **Plugins** → **Management**
3. 点击 **Choose File** 上传生成的 `dist/com.example.received-aggregator-1.0.0.tar.gz`
4. 启用插件

### 3. 配置插件

在插件管理页面找到 **Received Message Aggregator**，点击 **Settings**：

- **触发词列表**：设置触发聚合的关键词（用逗号分隔）
  - 默认：`收到,已收到,确认`
  - 示例：`收到,已收到,确认,OK,好的`

- **最大回溯消息数**：设置向前查找相同消息的范围
  - 默认：`10`
  - 建议：5-20之间

## 使用示例

### 基本使用

```
管理员: 请大家确认收到通知
用户A: 收到
用户B: 收到  
用户C: 收到
```

结果显示：
```
管理员: 请大家确认收到通知
系统: 收到 -- 用户A, 用户B, 用户C
```

### 自定义触发词

如果配置了触发词为 `收到,确认,OK`：

```
管理员: 会议时间确认
用户A: 确认
用户B: OK
用户C: 收到
```

结果显示：
```
管理员: 会议时间确认
系统: 确认 -- 用户A
系统: OK -- 用户B
系统: 收到 -- 用户C
```

## 技术细节

### 核心逻辑

1. **消息监听**：通过 `MessageHasBeenPosted` 钩子监听所有新消息
2. **触发词匹配**：检查消息是否完全匹配配置的触发词
3. **历史消息搜索**：在指定范围内查找最近的相同消息
4. **消息聚合**：更新现有消息或创建新的聚合消息
5. **重复检测**：避免同一用户重复出现在列表中

### 文件结构

```
mattermost-plugin-received-aggregator/
├── plugin.json          # 插件配置和元数据
├── plugin.go           # 主要插件逻辑
├── go.mod              # Go模块依赖
├── Makefile            # 构建脚本
└── README.md           # 说明文档
```

### API钩子使用

- `MessageHasBeenPosted`: 监听新消息
- `OnConfigurationChange`: 处理配置更新
- `GetPostsForChannel`: 获取频道历史消息
- `UpdatePost`: 更新消息内容
- `DeletePost`: 删除原始消息

## 开发和调试

### 本地开发

```bash
# 安装依赖
go mod tidy

# 运行测试
make test

# 构建开发版本
make debug-dist

# 部署到开发服务器
make deploy
```

### 调试技巧

1. 查看Mattermost日志：`tail -f mattermost.log`
2. 检查插件状态：System Console → Plugins → Management
3. 重启插件：`make reset`

## 常见问题

### Q: 插件不工作怎么办？
A: 
1. 检查插件是否已启用
2. 确认触发词配置正确
3. 查看Mattermost服务器日志是否有错误信息

### Q: 支持哪些消息类型？
A: 目前只支持普通文本消息，不支持包含附件、表情或格式化的消息

### Q: 可以支持多语言吗？
A: 是的，通过修改触发词配置可以支持不同语言的确认词

### Q: 消息聚合有数量限制吗？
A: 没有硬性限制，但建议保持合理数量以确保显示效果

## 许可证

本项目采用 MIT 许可证。详见 LICENSE 文件。

## 贡献

欢迎提交Issue和Pull Request来改进这个插件！

## 更新日志

### v1.0.0
- 初始版本发布
- 基本的消息聚合功能
- 可配置触发词和回溯范围
- 防重复用户显示